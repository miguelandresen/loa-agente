<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Agente LOA ‚Äì Demo mejorado (sin cr√©ditos)</title>
  <style>
    :root{--bg:#0b0f1a;--fg:#eef2f7;--muted:#90a3b6;--acc:#4fb3ff}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial,'Noto Sans',sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:22px}
    h1{margin:0 0 .25rem;font-size:1.6rem}
    .muted{color:var(--muted)}
    .panel{background:#0f1524;border:1px solid #1b2845;border-radius:12px;padding:16px;margin:16px 0}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{background:var(--acc);color:#001b2b;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    input[type="text"]{flex:1;min-width:260px;background:#0b1324;color:var(--fg);border:1px solid #1b2845;border-radius:10px;padding:10px}
    .log{max-height:420px;overflow:auto;padding:8px 0}
    .bubble{padding:10px 12px;border-radius:10px;margin:8px 0;max-width:100%}
    .me{background:#162646}
    .bot{background:#0f1d33}
    .small{font-size:.9rem}
    code.k{background:#10192e;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Agente Conversacional LOA ‚Äì Demo mejorado</h1>
    <div class="muted">Habla o escribe. El agente hace preguntas, recuerda el caso y propone una lente. 100% local en tu navegador.</div>

    <div class="panel">
      <div class="row">
        <button id="btnMic">üéôÔ∏è Hablar</button>
        <button id="btnStop" disabled>Detener</button>
        <input id="text" type="text" placeholder="Escribe o pulsa el micr√≥fono‚Ä¶">
        <button id="btnSend">Enviar</button>
      </div>
      <div class="log" id="log"></div>
    </div>

    <div class="panel small">
      <b>Prueba con:</b>
      <div><code class="k">estoy con un cliente de oficina, usa pantallas</code> ¬∑ <code class="k">mucha conducci√≥n nocturna</code> ¬∑ <code class="k">fotofobia exterior</code> ¬∑ <code class="k">lectura prolongada</code> ¬∑ <code class="k">control de miop√≠a infantil</code> ¬∑ <code class="k">filtros terap√©uticos</code> ¬∑ <code class="k">plazos</code> ¬∑ <code class="k">tarifa</code></div>
    </div>
  </div>

<script>
// --- Conocimiento base m√≠nimo ---
const KB = {
  contacto: "Direcci√≥n: C/ Charles Darwin, 17, Pol. El C√°√±amo II, 41309 La Rinconada (Sevilla). Tel: 955 515 251. Web: www.lentesloa.es. Pedidos: pedidos@lentesloa.com",
  catalogo: "Monofocales (Acomoda+), progresivas Elynxe (Revolution Plus/Elite Plus/Expert Plus), ocupacionales Infinito, bifocales/trifocales, Neochromes, MioChild, filtros terap√©uticos, sol/polarizadas/espejadas.",
  tratamientos: "Endurecido antirrayado; ARTOP (est√°ndar/avanzado); ARTOP Blue (filtro azul).",
  evolens: "Evolens: m√°s valor sin complicaciones. Materiales de apoyo, demo en tablet y medici√≥n; precio competitivo por debajo de la mediana.",
  premia: "PremIA: hiperpersonalizaci√≥n con IA (>100k usuarios) y garant√≠a de adaptaci√≥n 60 d√≠as (ajustes sin coste).",
  politica: "LOA es laboratorio: no damos precios de gafas completas. Tarifas de lentes solo a √≥pticas v√≠a Departamento Comercial: llamada o env√≠o por email/WhatsApp."
};

// --- Estado de di√°logo ---
const state = {
  caso: null, // pantallas|conduccion|exterior|lectura|miopia|terapeuticos
  usoHoras: null,
  progresivo: null,  // si/no
  fotocrom: null,    // si/no
  polarizada: null,  // si/no
  frag: 0,           // para variar cierres
  lastBot: ""
};

// Variaciones de estilo
const openings = [
  "Hola, soy el asistente de LOA. ¬øVemos r√°pido la mejor lente para tu cliente?",
  "Encantado, asistente LOA por aqu√≠. Te ayudo a afinar la elecci√≥n de lente."
];
const closings = [
  "¬øQuieres que pida una llamada de Comercial LOA o te env√≠o la tarifa por email/WhatsApp?",
  "¬øTe gestiono llamada comercial o prefieres que te env√≠e la tarifa al correo/WhatsApp?"
];

function once(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

// --- NLU simple por palabras clave ---
function detectCase(q){
  q = q.toLowerCase();
  if(/pantalla|oficina|ordenador|teletrabajo/.test(q)) return "pantallas";
  if(/conducci|noche|deslumbram/.test(q)) return "conduccion";
  if(/exterior|luz|fotofobi|sol/.test(q)) return "exterior";
  if(/lectura|cerca|libr(o|os)|estudio/.test(q)) return "lectura";
  if(/miop(i|√≠a)|infantil|ni√±|miochild/.test(q)) return "miopia";
  if(/filtro(s)? terap(e|√©)utico|patolog/.test(q)) return "terapeuticos";
  return null;
}

// --- Motor de di√°logo ---
function nextQuestion(){
  if(!state.caso) return "¬øPara qu√© uso principal es la lente: pantalla/oficina, conducci√≥n, exterior o lectura cercana?";
  if(state.caso!=="miopia" && state.caso!=="terapeuticos" && state.progresivo===null) return "¬øNecesita ver varias distancias en la misma gafa? Si es as√≠, valoramos progresivo; si no, monofocal u ocupacional.";
  if(state.usoHoras===null) return "¬øCu√°ntas horas al d√≠a usa ese entorno (aprox.)?";
  if(state.caso==="exterior" && state.polarizada===null) return "¬øPrefieres polarizada para cortar reflejos intensos?";
  if(state.caso!=="terapeuticos" && state.fotocrom===null) return "¬øTe encaja fotocrom√°tica (Neochromes) para transici√≥n interior/exterior?";
  return null;
}

function finalRecommendation(){
  const recs = [];
  const add = s => recs.push("‚Ä¢ "+s);

  switch(state.caso){
    case "pantallas":
      add("Ocupacional **Infinito** si el foco es intermedia+cerca; si requiere todas las distancias, **progresivo Elynxe** con estabilidad en zona intermedia.");
      add("Tratamiento **ARTOP** premium + **filtro selectivo** para confort en pantallas.");
      break;
    case "conduccion":
      add("**Progresivo Elynxe** con geometr√≠a estable y buen rendimiento perif√©rico.");
      add("**ARTOP** premium orientado a conducci√≥n nocturna (mejora contraste, reduce halos).");
      break;
    case "exterior":
      add("Valora **polarizada** para reducir reflejos y fatiga.");
      add("Seg√∫n estilo de vida, **Neochromes** para transici√≥n autom√°tica.");
      break;
    case "lectura":
      if(state.progresivo) add("**Progresivo Elynxe** con campo cercano amplio para lectura prolongada.");
      else add("**Monofocal** con **ARTOP** de alta limpieza y endurecido.");
      break;
    case "miopia":
      add("**MioChild**: control de miop√≠a infantil con desenfoque perif√©rico, uso diario y seguimiento peri√≥dico.");
      break;
    case "terapeuticos":
      add("**Filtros terap√©uticos**: seleccionar espectro seg√∫n patolog√≠a y sensibilidad; LOA ofrece asesoramiento t√©cnico para la elecci√≥n.");
      break;
    default:
      add("Puedo recomendar por uso: pantallas, conducci√≥n, exterior o lectura. Cu√©ntame el caso.");
  }

  if(state.fotocrom) add("A√±ade **Neochromes** si quiere comodidad interior/exterior.");
  const cierre = closings[state.frag++ % closings.length];
  return recs.join("\n") + "\n\n" + cierre;
}

function handleTurn(q){
  const low = q.toLowerCase();

  // Atajos informativos directos
  if(/contact|direc|tel[e√©]fono|correo|email|web/.test(low)) return KB.contacto;
  if(/cat[a√°]logo|gama|portafolio|opciones/.test(low)) return KB.catalogo;
  if(/tratamiento|ar|antirreflej|filtro azul|endurecido/.test(low)) return KB.tratamientos;
  if(/evolens/.test(low)) return KB.evolens;
  if(/prem.?ia/.test(low)) return KB.premia;
  if(/precio|tarifa|fabricaci[o√≥]n/.test(low)) return KB.politica;
  if(/plazo|entrega|d[i√≠]as/.test(low)) return "Plazo orientativo 3‚Äì7 d√≠as h√°biles seg√∫n dise√±o y tratamientos; la ETA se confirma con la orden.";

  // Detectar caso si a√∫n no lo hay
  const detected = detectCase(low);
  if(detected) state.caso = detected;

  // Responder preguntas guiadas
  const qnext = nextQuestion();
  if(qnext) return qnext;

  // Intentos de ‚Äús√≠/no‚Äù para flags
  if(/(s[i√≠]|vale|ok|correcto)/.test(low)){
    if(state.progresivo===null) state.progresivo = true;
    else if(state.fotocrom===null) state.fotocrom = true;
    else if(state.polarizada===null) state.polarizada = true;
    else if(state.usoHoras===null) state.usoHoras = 8;
    return nextQuestion() || finalRecommendation();
  }
  if(/(no|mejor no|prefiero no)/.test(low)){
    if(state.progresivo===null) state.progresivo = false;
    else if(state.fotocrom===null) state.fotocrom = false;
    else if(state.polarizada===null) state.polarizada = false;
    else if(state.usoHoras===null) state.usoHoras = 2;
    return nextQuestion() || finalRecommendation();
  }

  // Capturar horas aproximadas
  const h = low.match(/(\d{1,2})\s*h/);
  if(state.usoHoras===null && h){ state.usoHoras = parseInt(h[1]); return nextQuestion() || finalRecommendation(); }

  // Si todo est√° respondido, damos recomendaci√≥n final
  if(!nextQuestion()) return finalRecommendation();

  // Si seguimos sin contexto, abrimos
  return "Puedo ayudarte con pantallas, conducci√≥n, exterior, lectura, control de miop√≠a o filtros terap√©uticos. ¬øCu√°l es el caso del cliente?";
}

// --- UI y voz ---
const log = document.getElementById('log');
function addBubble(text, who='bot'){
  if(text===state.lastBot && who==='bot') return; // evita repetici√≥n exacta
  const div = document.createElement('div');
  div.className = `bubble ${who==='me'?'me':'bot'}`;
  div.textContent = text;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
  if(who==='bot') state.lastBot = text;
}
function speak(text){
  try{ const u=new SpeechSynthesisUtterance(text); u.lang='es-ES'; speechSynthesis.speak(u);}catch(_){}
}

function handleQuery(q){
  if(!q) return;
  addBubble(q,'me');
  const a = handleTurn(q);
  addBubble(a,'bot'); speak(a);
}

addBubble( openings[Math.floor(Math.random()*openings.length)] );

document.getElementById('btnSend').onclick = ()=>{
  const q = document.getElementById('text').value.trim();
  document.getElementById('text').value='';
  handleQuery(q);
};

let rec, listening=false;
const btnMic = document.getElementById('btnMic');
const btnStop = document.getElementById('btnStop');

function startRec(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ alert("Tu navegador no soporta reconocimiento de voz. Usa el cuadro de texto."); return; }
  rec = new SR();
  rec.lang = 'es-ES'; rec.interimResults = false;
  rec.onresult = (e)=>{
    const q = Array.from(e.results).map(r=>r[0].transcript).join(' ');
    handleQuery(q);
  };
  rec.onend = ()=>{ if(listening) rec.start(); };
  rec.start();
  listening=true; btnMic.disabled=true; btnStop.disabled=false;
}
function stopRec(){ if(rec){ listening=false; rec.stop(); } btnMic.disabled=false; btnStop.disabled=true; }

btnMic.onclick = startRec;
btnStop.onclick = stopRec;
</script>
</body>
</html>
